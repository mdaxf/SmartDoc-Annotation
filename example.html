
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartDoc - Ultimate Legacy Integration Demo</title>
    
    <!-- 
        ========================================
        MODE SELECTION
        ========================================
        This file is set up to work with the Vite Dev Server by default.
        To test the PRODUCTION BUNDLE (Legacy Mode):
        1. Run `npm run build`
        2. Uncomment the "PRODUCTION MODE" block below.
        3. Comment out the "DEVELOPMENT MODE" block at the bottom of <body>.
    -->

    <!-- --- PRODUCTION MODE STYLES (Uncomment after build) --- -->
    <!-- <link rel="stylesheet" href="./distribute/style.css"> -->

    <!-- --- DEVELOPMENT MODE STYLES (Leave active for npm run dev) --- -->
    <style>
        /* Basic Page Reset */
        body { margin: 0; padding: 0; font-family: -apple-system, system-ui, sans-serif; background: #0f172a; color: #e2e8f0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Header */
        header { background: #1e293b; border-bottom: 1px solid #334155; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; height: 70px; box-sizing: border-box; }
        h1 { margin: 0; font-size: 1.25rem; font-weight: 700; color: white; display: flex; align-items: center; gap: 10px; }
        .badge { background: #2563eb; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; text-transform: uppercase; font-weight: bold; }

        /* Layout */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        /* The App Container */
        #smart-doc-root { flex: 1; position: relative; background: #0f172a; }
        
        /* Sidebar Controls */
        aside { width: 350px; background: #1e293b; border-left: 1px solid #334155; display: flex; flex-direction: column; z-index: 20; }
        
        .panel-section { padding: 1rem; border-bottom: 1px solid #334155; }
        .panel-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; font-weight: bold; margin-bottom: 0.75rem; }
        
        /* Buttons Grid */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        button.ctrl-btn { background: #334155; border: 1px solid #475569; color: #e2e8f0; padding: 8px; border-radius: 6px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
        button.ctrl-btn:hover { background: #475569; border-color: #64748b; color: white; }
        button.ctrl-btn.active { background: #2563eb; border-color: #3b82f6; color: white; }
        
        /* Event Log */
        #log-container { flex: 1; overflow-y: auto; background: #0b1120; font-family: 'Menlo', 'Monaco', monospace; font-size: 11px; padding: 10px; }
        .log-entry { margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid #1e293b; animation: fadeIn 0.2s; }
        .log-time { color: #64748b; margin-right: 5px; }
        .log-key { color: #38bdf8; font-weight: bold; }
        .log-val { color: #94a3b8; word-break: break-all; }

        /* Error Overlay */
        #build-error { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: white; }
        .code-box { background: #333; padding: 15px; border-radius: 8px; font-family: monospace; margin: 15px 0; border: 1px solid #555; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>

    <!-- --- PRODUCTION MODE SCRIPT (Uncomment after build) --- -->
    <!-- <script src="./distribute/smart-doc.bundle.js"></script> -->

    <!-- Dependencies for DOCX support (Optional) -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx-preview@0.1.15/dist/docx-preview.min.js"></script>
</head>
<body>

    <div id="build-error">
        <h2 style="font-size: 2rem; color: #ef4444;">Library Not Found</h2>
        <p>The <code>window.SmartDoc</code> object is missing.</p>
        <p style="color: #ccc; max-width: 400px; margin-top: 10px;">If running via <b>npm run dev</b>, ensure the module script is active.<br>If testing production, ensure you ran <b>npm run build</b> and uncommented the production tags in this HTML.</p>
    </div>

    <header>
        <h1>
            <span>SmartDoc Integration</span>
            <span class="badge">Legacy / Vanilla JS</span>
        </h1>
        <div style="font-size: 0.85rem; color: #94a3b8;">
            Resize window to test responsiveness
        </div>
    </header>

    <div class="main-container">
        <!-- THE APP ROOT -->
        <div id="smart-doc-root"></div>

        <!-- SIDEBAR CONTROLS -->
        <aside>
            <!-- Mode Switcher -->
            <div class="panel-section">
                <div class="panel-title">Application Mode</div>
                <div class="btn-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <button class="ctrl-btn" onclick="reInit('full')">Full</button>
                    <button class="ctrl-btn" onclick="reInit('edit')">Edit</button>
                    <button class="ctrl-btn" onclick="reInit('viewonly')">View</button>
                </div>
            </div>

            <!-- Imperative API -->
            <div class="panel-section">
                <div class="panel-title">API Commands</div>
                <div class="btn-grid">
                    <button class="ctrl-btn" onclick="apiLoadPDF()">Load PDF</button>
                    <button class="ctrl-btn" onclick="apiLoadImages()">Load 3 Images</button>
                    <button class="ctrl-btn" onclick="apiGetJSON()">Log JSON</button>
                    <button class="ctrl-btn" onclick="apiClear()">Clear All</button>
                </div>
            </div>

            <!-- Event Logs -->
            <div class="panel-section" style="border-bottom: none; display: flex; justify-content: space-between; padding-bottom: 5px;">
                <div class="panel-title">Event Stream</div>
                <button class="ctrl-btn" style="padding: 2px 8px; font-size: 10px;" onclick="document.getElementById('log-container').innerHTML=''">Clear</button>
            </div>
            <div id="log-container">
                <div class="log-entry" style="color: #64748b;">Waiting for events...</div>
            </div>
        </aside>
    </div>

    <!-- --- DEVELOPMENT MODE SCRIPT (Comment out for Production testing) --- -->
    <script type="module">
        import { createSmartDoc } from './smartDoc.ts';
        // Mock global for dev mode consistency
        window.SmartDoc = { create: createSmartDoc };
        window.dispatchEvent(new Event('smartdoc-ready'));
    </script>

    <script>
        let docInstance = null;

        // --- 1. Event Logger Utility ---
        function log(event, data) {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString().split(' ')[0];
            
            let val = '';
            if (data) {
                if (typeof data === 'string') val = data;
                else val = JSON.stringify(data); // Simple stringify
                
                if (val.length > 100) val = val.substring(0, 100) + '...';
            }

            entry.innerHTML = `
                <span class="log-time">${time}</span>
                <span class="log-key">${event}</span>
                <div class="log-val">${val}</div>
            `;
            container.prepend(entry);
        }

        // --- 2. Initialization Function ---
        function initSmartDoc(mode = 'full') {
            if (!window.SmartDoc) return;

            // Unmount if exists
            if (docInstance) {
                docInstance.unmount();
                docInstance = null;
                log('System', 'Previous instance unmounted');
            }

            // A. Prepare Configuration
            const config = {
                // Initial Content
                documentSrc: [
                    'https://images.unsplash.com/photo-1552519507-da3b142c6e3d?auto=format&fit=crop&w=800&q=80',
                    'https://images.unsplash.com/photo-1542282088-fe8426682b8f?auto=format&fit=crop&w=800&q=80'
                ],

                // Pre-loaded Annotations (Simulate Database Load)
                initialAnnotations: [
                    {
                        id: 'init-1', 
                        documentId: '0', // Belongs to first image
                        type: 'rect', 
                        page: 1, 
                        x: 100, y: 100, width: 200, height: 150, 
                        color: '#ef4444', 
                        strokeWidth: 4, 
                        severity: 4, 
                        reasonCode: 'Damage',
                        status: 'New'
                    }
                ],

                // Core Settings
                mode: mode, // 'full', 'edit', 'viewonly'
                defaultLayout: 'sidebar', // 'sidebar' or 'bottom'
                navPosition: 'top',
                
                // UI Toggles
                hideLoadFileBtn: false,
                hideSaveJsonBtn: false,
                hideCameraBtn: false,
                showThumbnails: true,

                // Business Logic: Severity Colors
                severityOptions: {
                    1: '#22c55e', // Green
                    2: '#eab308', // Yellow
                    3: '#f97316', // Orange
                    4: '#ef4444'  // Red
                },

                // Business Logic: Dropdowns
                reasonCodeOptions: ['Dent', 'Scratch', 'Rust', 'Missing', 'Paint Chip'],
                statusOptions: ['New', 'In Progress', 'Approved', 'Rejected'],

                // CSS Styling Overrides (Optional)
                styleConfig: {
                    // Make background match our page theme
                    workspace: { backgroundColor: '#1e293b', backgroundImage: 'radial-gradient(#334155 1px, transparent 1px)' },
                    toolbar: { backgroundColor: '#0f172a' }
                }
            };

            // B. Prepare Event Listeners
            const events = {
                onSmartDocReady: () => log('Lifecycle', 'onSmartDocReady'),
                onDocumentReady: () => log('Lifecycle', 'onDocumentReady'),
                
                // Annotation Lifecycle
                onAnnotationAdd: (ann) => log('Annotation:Add', { id: ann.id, type: ann.type }),
                onAnnotationUpdate: (ann) => log('Annotation:Update', { id: ann.id, status: ann.status }),
                onAnnotationDelete: (id) => log('Annotation:Delete', id),
                onClearAnnotations: () => log('Action', 'Canvas Cleared'),
                
                // Data Events
                onSave: (data) => {
                    log('Action:Save', `File: ${data.file} (${data.annotations.length} items)`);
                    alert('Check logs for Save JSON');
                    console.log('FULL SAVE DATA:', data);
                },
                onPhotoAdd: (data) => log('Action:Camera', `New ID: ${data.id}`),
                onDocumentChange: (id) => log('Nav', `Switched to Doc ID: ${id}`)
            };

            // C. Create Instance
            try {
                docInstance = window.SmartDoc.create('smart-doc-root', config, events);
                log('System', `Initialized in ${mode.toUpperCase()} mode`);
            } catch (e) {
                console.error(e);
                log('Error', 'Failed to initialize');
            }
        }

        // --- 3. UI Helper Functions ---

        function reInit(mode) {
            // Update active button state
            document.querySelectorAll('.btn-grid button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            initSmartDoc(mode);
        }

        // API: Load PDF
        function apiLoadPDF() {
            if(!docInstance) return;
            log('API', 'Loading PDF...');
            docInstance.loadDocument('https://raw.githubusercontent.com/mozilla/pdf.js/ba2edeae/examples/learning/helloworld.pdf');
        }

        // API: Load Images
        function apiLoadImages() {
            if(!docInstance) return;
            log('API', 'Loading 3 Images...');
            docInstance.loadDocument([
                'https://images.unsplash.com/photo-1605218427306-02202067d8f5?auto=format&fit=crop&w=800&q=80',
                'https://images.unsplash.com/photo-1552519507-da3b142c6e3d?auto=format&fit=crop&w=800&q=80',
                'https://images.unsplash.com/photo-1494905998402-395d579af97d?auto=format&fit=crop&w=800&q=80'
            ]);
        }

        // API: Get JSON
        function apiGetJSON() {
            if(!docInstance) return;
            const anns = docInstance.getAnnotations();
            log('API:Get', `${anns.length} annotations found`);
            console.log('CURRENT ANNOTATIONS:', anns);
        }

        // API: Clear
        function apiClear() {
            if(!docInstance) return;
            docInstance.clearAnnotations();
        }

        // --- 4. Startup & Failsafe ---
        
        // Listen for dev mode ready event
        window.addEventListener('smartdoc-ready', () => {
             initSmartDoc('full');
             document.querySelector('.btn-grid button').classList.add('active');
        });

        // Fallback check for Production mode (where no event might fire if script loads fast)
        window.onload = function() {
            setTimeout(() => {
                if (window.SmartDoc && !docInstance) {
                    initSmartDoc('full');
                    document.querySelector('.btn-grid button').classList.add('active');
                } else if (!window.SmartDoc) {
                    document.getElementById('build-error').style.display = 'flex';
                }
            }, 500); // Small delay to allow module loading in Dev
        };

    </script>
</body>
</html>
